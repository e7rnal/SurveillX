<!-- SurveillX Live Monitor — 3-Panel Streaming -->
<div class="multi-stream-container">
    <!-- Top Controls Bar -->
    <div class="grid-controls">
        <div class="control-group">
            <span class="feed-label"><i class="fa-solid fa-tv"></i> Live Monitor</span>
        </div>
        <div class="control-group">
            <select id="stream-mode-select"
                style="background:var(--bg-tertiary);border:1px solid var(--border);color:var(--text-primary);padding:6px 12px;border-radius:6px;font-size:0.875rem;">
                <option value="jpegws">JPEG WebSocket</option>
                <option value="fastrtc">FastRTC</option>
            </select>
            <button class="btn btn-sm" id="connect-btn">
                <i class="fas fa-plug"></i> Connect
            </button>
            <button class="btn btn-sm" id="disconnect-btn" style="display:none;">
                <i class="fas fa-plug-circle-xmark"></i> Disconnect
            </button>
        </div>
    </div>

    <!-- Stream Panels Grid -->
    <div class="stream-panels">
        <!-- ========== MAIN STREAM (Large, top) ========== -->
        <div class="stream-panel main-panel" id="main-panel">
            <div class="panel-header">
                <span class="panel-label">
                    <i class="fa-solid fa-video"></i> <span id="camera-name">Main Camera</span>
                    <span class="panel-tag main-tag">LIVE</span>
                </span>
                <span class="panel-status" id="stream-status">
                    <i class="fa-solid fa-circle"></i> Disconnected
                </span>
            </div>
            <div class="panel-feed" style="aspect-ratio:16/9;">
                <canvas id="main-canvas" width="1280" height="720"></canvas>
                <!-- No Stream Overlay -->
                <div class="feed-overlay" id="feed-overlay">
                    <i class="fa-solid fa-video-slash"></i>
                    <div>No video stream</div>
                    <div class="hint">Click Connect to start streaming</div>
                </div>
            </div>
            <div class="panel-stats">
                <span><i class="fa-solid fa-gauge"></i> FPS: <strong id="fps-display">0</strong></span>
                <span><i class="fa-solid fa-expand"></i> <span id="resolution-display">--</span></span>
                <span id="connection-status">Latency: <strong id="latency-display">--</strong></span>
                <span>Frames: <strong id="frame-count">0</strong></span>
                <span>Mode: <strong id="current-mode">--</strong></span>
            </div>
        </div>

        <!-- ========== ACTIVITY DETECTION (Medium, bottom-left) ========== -->
        <div class="stream-panel activity-panel" id="activity-panel">
            <div class="panel-header">
                <span class="panel-label">
                    <i class="fa-solid fa-person-running"></i> Activity Detection
                    <span class="panel-tag activity-tag">SKELETON</span>
                </span>
                <span class="panel-activity-badge" id="activity-badge">Normal</span>
            </div>
            <div class="panel-feed" style="aspect-ratio:16/9;">
                <canvas id="activity-canvas" width="640" height="360"></canvas>
                <canvas id="skeleton-overlay" width="640" height="360"
                    style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;"></canvas>
                <div class="feed-overlay activity-waiting" id="activity-overlay">
                    <i class="fa-solid fa-bone"></i>
                    <div>Skeleton view ready</div>
                </div>
            </div>
            <div class="panel-stats">
                <span>Activity: <strong id="activity-status" style="color:#22c55e;">Normal</strong></span>
                <span>Persons: <strong id="person-count">0</strong></span>
                <span>Confidence: <strong id="activity-confidence">--</strong></span>
            </div>
        </div>

        <!-- ========== FACIAL RECOGNITION (Small, bottom-right) ========== -->
        <div class="stream-panel face-panel" id="face-panel">
            <div class="panel-header">
                <span class="panel-label">
                    <i class="fa-solid fa-face-smile"></i> Facial Recognition
                    <span class="panel-tag face-tag">DETECT</span>
                </span>
                <span class="face-beep-toggle" title="Toggle beep sound">
                    <i class="fa-solid fa-volume-high" id="beep-icon"></i>
                </span>
            </div>
            <div class="panel-feed" style="aspect-ratio:16/9;">
                <canvas id="face-canvas" width="640" height="360"></canvas>
                <div class="feed-overlay face-waiting" id="face-overlay">
                    <i class="fa-solid fa-user-shield"></i>
                    <div>Face scan ready</div>
                </div>
            </div>
            <div class="panel-stats">
                <span>Faces: <strong id="face-count">0</strong></span>
                <span>Known: <strong id="known-faces-count" style="color:#8b5cf6;">--</strong></span>
                <span>Recognized: <strong id="recognized-count" style="color:#22c55e;">0</strong></span>
                <span>Unknown: <strong id="unknown-count" style="color:#6366f1;">0</strong></span>
            </div>
        </div>
    </div>

    <!-- Right Sidebar -->
    <div class="live-sidebar">
        <div class="card">
            <h3><i class="fa-solid fa-user-check"></i> Recognized Faces</h3>
            <div id="recognized-faces-list" style="max-height: 200px; overflow-y: auto;">
                <div class="empty-state small">
                    <i class="fa-solid fa-user-slash"></i>
                    <p>No faces recognized yet</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h3><i class="fa-solid fa-bell"></i> Live Detections</h3>
            <div id="live-detections" class="detection-list" style="max-height: 200px; overflow-y: auto;">
                <div class="empty-state small">
                    <i class="fa-solid fa-eye-slash"></i>
                    <p>No detections</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h3><i class="fa-solid fa-camera"></i> Quick Actions</h3>
            <button class="btn secondary full-width" onclick="window.captureSnapshot()" style="margin-bottom:0.5rem;">
                <i class="fa-solid fa-camera"></i> Capture Snapshot
            </button>
            <button class="btn secondary full-width" onclick="window.renameCamera()" style="margin-bottom:0.5rem;">
                <i class="fa-solid fa-pen"></i> Rename Camera
            </button>
            <button class="btn secondary full-width" id="fullscreen-toggle">
                <i class="fa-solid fa-expand"></i> Fullscreen Main
            </button>
        </div>
    </div>
</div>

<script>
    // 3-Panel Stream Manager
    (function () {
        const StreamManager = {
            isConnected: false,
            streamMode: 'jpegws',
            beepEnabled: true,   // Toggle beep sound
            _audioCtx: null,
            _personBeepMap: {},  // student_id → last beep timestamp
            _beepCooldownMs: 30000, // 30s per person before beeping again

            init() {
                this.setupControls();
                this.loadStreamConfig();
                this.syncUIWithApp();
            },

            setupControls() {
                document.getElementById('connect-btn')?.addEventListener('click', () => this.connect());
                document.getElementById('disconnect-btn')?.addEventListener('click', () => this.disconnect());

                document.getElementById('stream-mode-select')?.addEventListener('change', (e) => {
                    this.streamMode = e.target.value;
                    this.saveStreamConfig();
                    if (this.isConnected) {
                        this.disconnect();
                        setTimeout(() => this.connect(), 500);
                    }
                });

                document.getElementById('fullscreen-toggle')?.addEventListener('click', () => {
                    const panel = document.getElementById('main-panel');
                    if (!document.fullscreenElement) {
                        panel.requestFullscreen();
                    } else {
                        document.exitFullscreen();
                    }
                });

                // Beep toggle
                document.querySelector('.face-beep-toggle')?.addEventListener('click', () => {
                    this.beepEnabled = !this.beepEnabled;
                    const icon = document.getElementById('beep-icon');
                    if (icon) {
                        icon.className = this.beepEnabled
                            ? 'fa-solid fa-volume-high'
                            : 'fa-solid fa-volume-xmark';
                    }
                });
            },

            async loadStreamConfig() {
                try {
                    const response = await fetch('/api/stream/config');
                    const data = await response.json();
                    this.streamMode = data.current_mode || 'jpegws';
                    const select = document.getElementById('stream-mode-select');
                    if (select) select.value = this.streamMode;
                    document.getElementById('current-mode').textContent = this.streamMode.toUpperCase();
                } catch (error) {
                    console.error('Failed to load stream config:', error);
                }
            },

            async saveStreamConfig() {
                try {
                    await fetch('/api/stream/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mode: this.streamMode })
                    });
                } catch (error) {
                    console.error('Failed to save stream config:', error);
                }
            },

            connect() {
                if (this.isConnected) return;
                if (window.app && window.app.connectSocket) {
                    window.app.connectSocket();
                    setTimeout(() => {
                        if (window.app.socket) {
                            this.isConnected = true;
                            this.updateConnectionUI(true);
                            console.log('Connected to stream');
                        } else {
                            this.updateConnectionUI(false, 'Socket connection failed');
                        }
                    }, 500);
                }
            },

            disconnect() {
                this.isConnected = false;
                this.updateConnectionUI(false);

                ['main-canvas', 'activity-canvas', 'face-canvas'].forEach(id => {
                    const c = document.getElementById(id);
                    if (c) c.getContext('2d').clearRect(0, 0, c.width, c.height);
                });
            },

            updateConnectionUI(connected, error = null) {
                const status = document.getElementById('stream-status');
                const connectBtn = document.getElementById('connect-btn');
                const disconnectBtn = document.getElementById('disconnect-btn');
                const overlay = document.getElementById('feed-overlay');

                if (connected) {
                    if (status) status.innerHTML = '<i class="fa-solid fa-circle" style="color:#10b981;"></i> Connected';
                    if (overlay) overlay.style.display = 'none';
                    if (connectBtn) connectBtn.style.display = 'none';
                    if (disconnectBtn) disconnectBtn.style.display = 'inline-flex';
                } else {
                    if (status) status.innerHTML = '<i class="fa-solid fa-circle" style="color:#ef4444;"></i> Disconnected';
                    if (overlay) overlay.style.display = 'flex';
                    if (connectBtn) connectBtn.style.display = 'inline-flex';
                    if (disconnectBtn) disconnectBtn.style.display = 'none';
                }
            },

            // --- Beep Sound via Web Audio API ---
            playBeep() {
                if (!this.beepEnabled) return;

                try {
                    if (!this._audioCtx) this._audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    const ctx = this._audioCtx;

                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();

                    osc.connect(gain);
                    gain.connect(ctx.destination);

                    osc.type = 'sine';
                    osc.frequency.value = 880; // A5 note

                    gain.gain.setValueAtTime(0.3, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);

                    osc.start(ctx.currentTime);
                    osc.stop(ctx.currentTime + 0.3);
                } catch (e) {
                    console.warn('Beep error:', e);
                }
            },

            syncUIWithApp() {
                if (window.app && window.app.socket && window.app.socket.connected) {
                    this.isConnected = true;
                    this.updateConnectionUI(true);
                }
                this.connectToDetections();
                this.loadKnownFacesCount();
            },

            connectToDetections() {
                const setupListener = () => {
                    if (window.app && window.app.socket) {
                        window.app.socket.on('detection', (data) => {
                            this.handleDetection(data);
                        });
                    } else {
                        setTimeout(setupListener, 500);
                    }
                };
                setupListener();

                // REST polling fallback
                this._pollInterval = setInterval(async () => {
                    try {
                        const resp = await fetch('/api/detections/latest');
                        if (resp.ok) {
                            const data = await resp.json();
                            if (data.faces && data.faces.length > 0) {
                                this.handleDetection(data);
                            }
                        }
                    } catch (e) { }
                }, 3000);
            },

            async loadKnownFacesCount() {
                try {
                    const resp = await fetch('/api/internal/known-faces');
                    if (resp.ok) {
                        const data = await resp.json();
                        const el = document.getElementById('known-faces-count');
                        if (el) el.textContent = data.faces ? data.faces.length : 0;
                    }
                } catch (e) { }
            },

            handleDetection(data) {
                const faces = data.faces || [];
                const faceCount = document.getElementById('face-count');
                if (faceCount) faceCount.textContent = faces.length;

                // Beep per recognized person — once every 30s per student
                const now = Date.now();
                for (const f of faces) {
                    if (!f.student_id) continue;
                    const key = String(f.student_id);
                    const lastBeep = this._personBeepMap[key] || 0;
                    if (now - lastBeep >= this._beepCooldownMs) {
                        this._personBeepMap[key] = now;
                        this.playBeep();
                        break; // one beep per detection event max
                    }
                }

                this.updateFaceRecognitionPanel(faces);
                this.updateDetectionsList(faces);
            },

            updateFaceRecognitionPanel(faces) {
                const recognized = faces.filter(f => f.student_id);
                const unknown = faces.filter(f => !f.student_id);

                const recognizedCount = document.getElementById('recognized-count');
                const unknownCount = document.getElementById('unknown-count');
                if (recognizedCount) recognizedCount.textContent = recognized.length;
                if (unknownCount) unknownCount.textContent = unknown.length;

                const list = document.getElementById('recognized-faces-list');
                if (!list) return;

                if (faces.length === 0) {
                    list.innerHTML = '<div class="empty-state small"><i class="fa-solid fa-user-slash"></i><p>No faces recognized yet</p></div>';
                    return;
                }

                const now = new Date().toLocaleTimeString();
                list.innerHTML = faces.map(face => {
                    const name = face.student_name || 'Unknown';
                    const conf = face.confidence ? `${(face.confidence * 100).toFixed(0)}%` : '';
                    const isRecognized = !!face.student_id;
                    const color = isRecognized ? '#10b981' : '#6366f1';
                    const icon = isRecognized ? 'fa-user-check' : 'fa-user-xmark';

                    return `
                        <div style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem;border-radius:8px;background:rgba(255,255,255,0.03);margin-bottom:0.4rem;border-left:3px solid ${color};">
                            <div style="width:32px;height:32px;border-radius:50%;background:${color}22;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                                <i class="fa-solid ${icon}" style="color:${color};font-size:0.8rem;"></i>
                            </div>
                            <div style="flex:1;min-width:0;">
                                <div style="font-weight:600;font-size:0.8rem;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${name}</div>
                                <div style="font-size:0.7rem;color:var(--text-secondary);">
                                    <span style="color:${color};">${isRecognized ? 'Recognized' : 'Unknown'}</span>
                                    ${conf ? `· ${conf}` : ''} · ${now}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            updateDetectionsList(faces) {
                const list = document.getElementById('live-detections');
                if (!list) return;

                if (faces.length === 0) {
                    list.innerHTML = '<div class="empty-state small"><i class="fa-solid fa-eye-slash"></i><p>No detections</p></div>';
                    return;
                }

                list.innerHTML = faces.map(face => {
                    const name = face.student_name || 'Unknown';
                    const conf = face.confidence ? `${(face.confidence * 100).toFixed(0)}%` : '';
                    const color = face.student_id ? '#10b981' : '#6b7280';

                    return `
                        <div style="display:flex;align-items:center;gap:0.5rem;padding:0.4rem;border-bottom:1px solid var(--border);">
                            <div style="width:28px;height:28px;font-size:0.7rem;background:${color};color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;">${name[0] || '?'}</div>
                            <div style="flex:1;">
                                <div style="font-size:0.8rem;font-weight:500;">${name}</div>
                                <div style="font-size:0.7rem;color:var(--text-secondary);">${conf}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        };

        // Global functions
        window.captureSnapshot = function () {
            const canvas = document.getElementById('main-canvas');
            if (!canvas) return;
            const link = document.createElement('a');
            link.download = `snapshot_${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            if (window.Toast) Toast.success('Snapshot saved!');
        };

        window.renameCamera = function () {
            const el = document.getElementById('camera-name');
            const newName = prompt('Enter new camera name:', el?.textContent || 'Main Camera');
            if (newName && newName.trim()) {
                el.textContent = newName.trim();
                localStorage.setItem('cameraName', newName.trim());
                if (window.Toast) Toast.success('Camera renamed!');
            }
        };

        // Auto-init
        const initWhenReady = () => {
            if (document.getElementById('stream-mode-select')) {
                StreamManager.init();
                const savedName = localStorage.getItem('cameraName');
                if (savedName) document.getElementById('camera-name').textContent = savedName;
            } else {
                setTimeout(initWhenReady, 100);
            }
        };
        setTimeout(initWhenReady, 100);
    })();
</script>

<style>
    /* ===== Multi-Stream Container ===== */
    .multi-stream-container {
        display: grid;
        grid-template-columns: 1fr 280px;
        grid-template-rows: auto 1fr;
        gap: 1rem;
    }

    .grid-controls {
        grid-column: 1 / -1;
        grid-row: 1;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
    }

    .control-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* ===== Stream Panels Grid ===== */
    .stream-panels {
        grid-column: 1;
        grid-row: 2;
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto auto;
        gap: 1rem;
    }

    .stream-panel {
        border: 1px solid var(--border);
        border-radius: 10px;
        overflow: hidden;
        background: var(--bg-card);
        transition: border-color 0.3s, box-shadow 0.3s;
    }

    .stream-panel:hover {
        border-color: rgba(139, 92, 246, 0.3);
        box-shadow: 0 0 20px rgba(139, 92, 246, 0.08);
    }

    /* Main panel spans full width */
    .main-panel {
        grid-column: 1 / -1;
        border-color: rgba(139, 92, 246, 0.2);
    }

    /* ===== Panel Header ===== */
    .panel-header {
        padding: 0.6rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border);
        background: var(--bg-tertiary);
    }

    .panel-label {
        font-weight: 600;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .panel-tag {
        font-size: 0.6rem;
        font-weight: 700;
        padding: 2px 6px;
        border-radius: 4px;
        letter-spacing: 0.05em;
        text-transform: uppercase;
    }

    .main-tag {
        background: rgba(139, 92, 246, 0.2);
        color: #a78bfa;
    }

    .activity-tag {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
    }

    .face-tag {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
    }

    .panel-status {
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
        color: var(--text-secondary);
    }

    .panel-activity-badge {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 3px 10px;
        border-radius: 20px;
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
        transition: all 0.3s;
    }

    .panel-activity-badge.abnormal {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
        animation: pulse-badge 1s infinite;
    }

    @keyframes pulse-badge {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.6;
        }
    }

    .face-beep-toggle {
        cursor: pointer;
        font-size: 0.9rem;
        color: var(--text-secondary);
        transition: color 0.2s;
        padding: 4px;
    }

    .face-beep-toggle:hover {
        color: var(--text-primary);
    }

    /* ===== Panel Feed (Canvas) ===== */
    .panel-feed {
        position: relative;
        background: #0a0a0f;
        overflow: hidden;
    }

    .panel-feed canvas {
        width: 100%;
        height: 100%;
        display: block;
    }

    .feed-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.85);
        color: rgba(255, 255, 255, 0.4);
        font-size: 2.5rem;
        z-index: 2;
    }

    .feed-overlay div {
        font-size: 0.85rem;
        margin-top: 0.6rem;
    }

    .feed-overlay .hint {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.25);
    }

    .activity-waiting {
        background: rgba(0, 0, 0, 0.8);
        border-bottom: 2px solid rgba(245, 158, 11, 0.3);
    }

    .face-waiting {
        background: rgba(0, 0, 0, 0.8);
        border-bottom: 2px solid rgba(34, 197, 94, 0.3);
    }

    /* ===== Panel Stats Bar ===== */
    .panel-stats {
        padding: 0.5rem 0.75rem;
        border-top: 1px solid var(--border);
        background: var(--bg-tertiary);
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.75rem;
        color: var(--text-secondary);
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .panel-stats strong {
        color: var(--text-primary);
    }

    /* ===== Live Sidebar ===== */
    .live-sidebar {
        grid-column: 2;
        grid-row: 2;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .live-sidebar .card {
        padding: 1rem;
    }

    .live-sidebar .card h3 {
        font-size: 0.85rem;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* ===== Responsive ===== */
    @media (max-width: 1200px) {
        .multi-stream-container {
            grid-template-columns: 1fr;
        }

        .live-sidebar {
            grid-row: auto;
            flex-direction: row;
            flex-wrap: wrap;
        }

        .live-sidebar .card {
            flex: 1;
            min-width: 200px;
        }
    }

    @media (max-width: 768px) {
        .stream-panels {
            grid-template-columns: 1fr;
        }

        .main-panel {
            grid-column: 1;
        }
    }
</style>